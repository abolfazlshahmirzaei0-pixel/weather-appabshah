<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هواشناسی ایران 🇮🇷</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #00838f;
            --secondary-color: #00bfa5;
            --accent-color: #00796b;
            --card-bg: #ffffff;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --card-hover-shadow: 0 15px 45px rgba(0, 0, 0, 0.15);
            --border-radius: 20px;
            --temp-color: #d32f2f;
            --humidity-color: #0277bd;
            --wind-color: #558b2f;
            --pop-color: #03a9f4;
            --sunrise-color: #ff9800;
            --sunset-color: #e53935;
            --feels-like-color: #9c27b0;
            --pressure-color: #4caf50;
            --wind-direction-color: #ff5722;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
            background-color: #f0f4f7;
            margin: 0;
            padding: 0;
            color: #333;
            line-height: 1.6;
            transition: background-color 1s ease-in-out;
            position: relative;
        }

        /* Dynamic Backgrounds */
        body.bg-clear { background: linear-gradient(to bottom, #87ceeb, #e0f4f7); }
        body.bg-clouds { background: linear-gradient(to bottom, #b0bec5, #eceff1); }
        body.bg-rain { background: linear-gradient(to bottom, #607d8b, #cfd8dc); }
        body.bg-snow { background: linear-gradient(to bottom, #cfd8dc, #f0f4f7); }
        body.bg-thunderstorm { background: linear-gradient(to bottom, #424242, #757575); }
        body.bg-mist { background: linear-gradient(to bottom, #9e9e9e, #bdbdbe); }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            transition: background 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        header.night-header {
            background: linear-gradient(135deg, #1a237e, #303f9f);
        }

        header h1 {
            margin: 0;
            font-size: 2.8em;
            font-weight: 700;
        }

        header p {
            margin: 10px 0 0;
            font-size: 1.1em;
            font-weight: 400;
        }
        
        #header-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .header-message {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 15px;
            margin-top: 20px;
            font-size: 0.9em;
            font-weight: 400;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: none; /* Initially hidden */
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            max-width: 960px;
            margin: 30px auto;
            padding: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--card-hover-shadow);
        }

        .selectors-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .selector-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        select {
            padding: 12px 20px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            min-width: 200px;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: right;
            -moz-appearance: none;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 15px center;
            padding-left: 40px;
        }

        select:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 0 8px rgba(0, 191, 165, 0.2);
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 131, 143, 0.3);
        }

        #weather-info {
            text-align: center;
        }

        .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden { display: none; }

        h2 {
            font-size: 2em;
            color: var(--accent-color);
            border-bottom: 2px solid #e0f2f1;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .weather-data-card {
            background: linear-gradient(145deg, #e0f7fa, #ffffff);
            padding: 30px;
            border-radius: var(--border-radius);
            display: inline-block;
            min-width: 380px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            text-align: right;
            margin-top: 20px;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .weather-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 15px;
            box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.1);
            font-size: 4em;
            color: var(--primary-color);
        }
        .weather-icon img {
            max-width: 100%;
            max-height: 100%;
        }

        .weather-data-card p {
            margin: 10px 0;
            font-size: 1.1em;
            text-align: right;
        }

        .weather-data-card p strong {
            display: inline-block;
            min-width: 120px;
        }

        .weather-data-card strong {
            color: var(--accent-color);
        }

        #forecast {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }

        .forecast-card {
            background: linear-gradient(145deg, #fdfdfd, #f0f4f7);
            padding: 20px;
            border-radius: 16px;
            width: 180px;
            text-align: right;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .forecast-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
        }

        .forecast-card .weather-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 10px;
            font-size: 3em;
        }

        .forecast-card p {
            font-size: 0.9em;
            margin: 5px 0;
        }
        .forecast-card h4 {
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .forecast-card p strong {
            display: inline-block;
            min-width: 100px;
            text-align: right;
        }

        #feedback-section {
            background-color: #fffde7;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #feedback-form .form-group {
            margin-bottom: 15px;
        }

        #feedback-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--accent-color);
        }

        #feedback-form input, #feedback-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #f9f9f9;
            transition: border-color 0.3s;
        }

        #feedback-form input:focus, #feedback-form textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        #feedback-form button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 121, 107, 0.2);
        }

        #feedback-form button:hover {
            background-color: #004d40;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 121, 107, 0.3);
        }

        #comments-list {
            list-style: none;
            padding: 0;
            margin-top: 25px;
        }

        #comments-list li {
            background-color: #fff;
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-right: 5px solid var(--secondary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .temp-color { color: var(--temp-color); }
        .humidity-color { color: var(--humidity-color); }
        .wind-color { color: var(--wind-color); }
        .pop-color { color: var(--pop-color); }
        .current-city-name { color: var(--accent-color); font-weight: 700; }
        .temp-min-max { color: var(--temp-color); }
        .temp-min-max strong { font-size: 1.2em; }
        .temp-min-max i { font-size: 0.8em; }

        footer {
            text-align: center;
            padding: 20px;
            background-color: #cfd8dc;
            color: #555;
            font-size: 14px;
            box-shadow: inset 0 1px 0 rgba(0, 0, 0, 0.1);
        }

        /* Rain effect styling */
        .rain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .drop {
            position: absolute;
            background-color: #fff;
            opacity: 0.6;
            animation: rain-fall linear infinite;
        }

        @keyframes rain-fall {
            0% {
                transform: translateY(-100px);
                opacity: 0.6;
            }
            100% {
                transform: translateY(100vh);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .selectors-section {
                flex-direction: column;
                align-items: stretch;
            }
            .selector-group {
                flex-direction: column;
                align-items: flex-start;
            }
            select {
                min-width: 100%;
                text-align: right;
            }
            .weather-data-card {
                min-width: auto;
            }
            .forecast-card {
                width: 100%;
                text-align: center;
            }
            .forecast-card p strong {
                display: block;
                min-width: unset;
                text-align: center;
            }
        }
    </style>
</head>
<body>
<header>
    <div id="header-icon"></div>
    <h1>هواشناسی ایران 🇮🇷</h1>
    <p id="live-time">در حال بارگذاری زمان...</p>
    <p id="header-message" class="header-message">آیکون بالای سایت وضعیت فعلی آب‌وهوا را نشان می‌دهد (آفتابی، ابری، بارانی و...)</p>
</header>
<main class="container">
    <section class="card selectors-section">
        <div class="selector-group">
            <label for="province-select">استان:</label>
            <select id="province-select"><option value="">استان را انتخاب کنید</option></select>
        </div>
        <div class="selector-group">
            <label for="city-select">شهر:</label>
            <select id="city-select" disabled><option value="">شهر را انتخاب کنید</option></select>
        </div>
    </section>

    <section id="weather-info">
        <div id="loading-spinner" class="spinner hidden"></div>
        <div id="current-weather" class="card">
            <h2><span id="current-city-title">وضعیت فعلی</span></h2>
            <div class="weather-data-card" id="current-data">
                <p>لطفاً یک استان و شهر را انتخاب کنید.</p>
            </div>
        </div>
        <div id="forecast-section" class="card">
            <h2>پیش‌بینی ۵ روزه</h2>
            <div id="forecast"></div>
        </div>
    </section>
    <section id="feedback-section" class="card">
        <h2>فرم نظرات</h2>
        <form id="feedback-form">
            <div class="form-group">
                <label for="feedback-name">نام:</label>
                <input type="text" id="feedback-name" required>
            </div>
            <div class="form-group">
                <label for="feedback-comment">نظر:</label>
                <textarea id="feedback-comment" rows="4" required></textarea>
            </div>
            <button type="submit">ثبت نظر</button>
        </form>
        <h3>نظرات ثبت‌شده</h3>
        <ul id="comments-list"></ul>
    </section>
</main>
<footer>
    <p>ساخته شده توسط ابوالفضل شاهمیرزایی ❤️</p>
    <p>&copy; ۱۴۰۴</p>
    <p>سایت از API <a href="https://openweathermap.org/" target="_blank">OpenWeatherMap</a> استفاده می‌کند</p>
</footer>
<script>
    const API_KEY = 'bf8755006c2fc6e2762533c174860bf6';
    const provinces = {
        "آذربایجان شرقی": ["تبریز","مراغه","مرند","اهر","میانه","بناب","شبستر","جلفا","سهند","سراب","هشترود","کلیبر","اسکو","بستان‌آباد","آذرشهر","هریس","عجب‌شیر","ورزقان","ملکان","قره‌آغاج","مبارک‌شهر","تسوج","خسروشاه","صوفیان","شرفخانه","ترکمنچای","باروق","لیلان","شهر جدید سهند"],
        "آذربایجان غربی": ["ارومیه","خوی","مهاباد","بوکان","میاندوآب","سلماس","پیرانشهر","نقده","شاهین‌دژ","سردشت","ماکو","تکاب","اشنویه","قره‌ضیاءالدین","چایپاره","پلدشت","شوط","سیروان","ربط","بازرگان","نوشین‌شهر","قوشچی","کرمانج","یولاگلدی","سیلوانا"],
        "اردبیل": ["اردبیل","پارس‌آباد","مشگین‌شهر","خلخال","نمین","نیر","گرمی","بیله‌سوار","کوثر","سرعین","گیوی","اصلاندوز","هیر","جعفرآباد","فیروزآباد","کلور","تازه کند","کوراییم","اسلام‌آباد","پویاشهر","رضی"],
        "اصفهان": ["اصفهان","کاشان","خمینی‌شهر","نجف‌آباد","فلاورجان","شاهین‌شهر","شهرضا","مبارکه","زرین‌شهر","گلپایگان","خوانسار","نایین","درچه","اردستان","چادگان","دولت‌آباد","لنجان","میمه","فولادشهر","کوهپایه","آران و بیدگل","ورزنه","دهاقان","سمیرم"],
        "البرز": ["کرج","فردیس","کمال‌شهر","نظرآباد","محمدشهر","ماهدشت","مهرشهر","هشتگرد","اشتهارد","طالقان","چهارباغ","گوهردشت","کوهسار","کوهک","ساوجبلاغ","هشتگرد جدید"],
        "ایلام": ["ایلام","دهلران","دره‌شهر","ایوان","مهران","آبدانان","سرابله","چرداول","بدره","ملکشاهی","لومار","موسیان","چوار","میمه","ارکواز"],
        "بوشهر": ["بوشهر","برازجان","گناوه","خورموج","کنگان","عسلویه","جم","دیلم","دیر","شبانکاره","کاکی","اهرم","خارگ","بندر سیراف","بندر ریگ","بندر دیر","آبپخش","سعدآباد","دلوار","چغادک"],
        "تهران": ["تهران","اسلام‌شهر","شهریار","قدس","ملارد","نسیم‌شهر","ری","رباط‌کریم","ورامین","قرچک","پاکدشت","اندیشه","پردیس","دماوند","بومهن","شریف‌آباد","رودهن","کهریزک","باغستان","فردوسیه","شهر ری","باقرشهر","واوان","فشافویه","چیتگر"],
        "چهارمحال و بختیاری": ["شهرکرد","بروجن","فارسان","لردگان","اردل","کوهرنگ","سامان","بن","کیار","فرخ‌شهر","بلداجی","سورشجان","چلگرد","جونقان","گندمان","ناغان","شلمزار","باباحیدر","دشتک"],
        "خراسان جنوبی": ["بیرجند","قائن","فردوس","نهبندان","طبس","سرایان","بشرویه","خوسف","اسدیه","درمیان","زیرکوه","آیسک","قهستان","مود","دیهوک"],
        "خراسان رضوی": ["مشهد","سبزوار","نیشابور","تربت حیدریه","کاشمر","قوچان","بردسکن","چناران","فریمان","خواف","تایباد","تربت جام","گناباد","درگز","سرخس","کلات","رشتخوار","مه ولات","طرقبه","شاندیز","بجستان","خلیل‌آباد"],
        "خراسان شمالی": ["بجنورد","شیروان","اسفراین","جاجرم","مانه و سملقان","فاروج","گرمه","راز و جرگلان","قاضی","درق","ایور","آوا","لوجلی","غلامان","زیارت","آشخانه"],
        "خوزستان": ["اهواز","دزفول","آبادان","خرمشهر","اندیمشک","مسجدسلیمان","ایذه","بهبهان","شوشتر","ماهشهر","سوسنگرد","شوش","باغ‌ملک","رامشیر","شادگان","امیدیه","هندیجان","لالی","رامهرمز","دشت آزادگان","اندیکا","شوش","دشت‌آزادگان"],
        "زنجان": ["زنجان","ابهر","خرمدره","قیدار","سلطانیه","ماهنشان","سجاس","زرین‌آباد","دندی","ارمغانخانه","نوربهار","سجین","هیدج","صایین‌قلعه","آب‌بر","سهرورد","چورزق"],
        "سمنان": ["سمنان","شاهرود","دامغان","گرمسار","مهدی‌شهر","ایوانکی","بسطام","میامی","سرخه","دیباج","بیارجمند","شهمیرزاد","کالپوش","مجین","حسین‌آباد"],
        "سیستان و بلوچستان": ["زاهدان","زابل","ایرانشهر","چابهار","خاش","سراوان","کنارک","نیک‌شهر","سرباز","راسک","فنوج","مهرستان","قصرقند","سیب و سوران","دشتیاری","دلگان","پیشین"],
        "فارس": ["شیراز","مرودشت","کازرون","جهرم","فسا","لار","فیروزآباد","اقلید","داراب","لامرد","نورآباد","ممسنی","نی‌ریز","آباده","صفاشهر","استهبان","گراش","خنج","قیر و کارزین","پاسارگاد","بوانات","سروستان"],
        "قزوین": ["قزوین","تاکستان","الوند","اقبالیه","آبیک","بیدستان","بوئین‌زهرا","شال","مهرگان","اسفرورین","کوهین","آوج","ضیاءآباد","خاکعلی"],
        "قم": ["قم","جعفریه","کهک","سلفچگان","دستجرد","قنوات","کوشا","قمصر"],
        "کردستان": ["سنندج","سقز","مریوان","بانه","قروه","کامیاران","دیواندره","بیجار","سروآباد","دهگلان","موچش","سریش‌آباد","دلبران"],
        "کرمان": ["کرمان","سیرجان","رفسنجان","جیرفت","بم","کهنوج","بافت","بردسیر","زرند","عنبرآباد","شهربابک","منوجان","قلعه‌گنج","راور","کوهبنان","ریگان","فهرج","انار","رودبار"],
        "کرمانشاه": ["کرمانشاه","اسلام‌آباد غرب","جوانرود","کنگاور","صحنه","سنقر","پاوه","هرسین","قصر شیرین","سرپل ذهاب","گیلانغرب","روانسر","ثلاث باباجانی","کوزران","ماهیدشت"],
        "کهگیلویه و بویراحمد": ["یاسوج","گچساران","دوگنبدان","دهدشت","لیکک","باشت","سی‌سخت","چرام","لنده","سوق","پاتاوه","مادوان"],
        "گلستان": ["گرگان","گنبد کاووس","بندر ترکمن","علی‌آباد کتول","آق‌قلا","کردکوی","مینودشت","گالیکش","کلاله","رامیان","آزادشهر","گمیشان","سیمین‌شهر","نوکنده","خان ببین","اینچه‌برون"],
        "گیلان": ["رشت","انزلی","لاهیجان","لنگرود","تالش","رودبار","رودسر","فومن","صومعه‌سرا","آستانه اشرفیه","آستارا","ماسال","سیاهکل","املش","رضوان‌شهر","کوچصفهان","کیاشهر","شفت","چمخاله","رحیم‌آباد","لوشان","کلاچای"],
        "لرستان": ["خرم‌آباد","بروجرد","دورود","کوهدشت","الیگودرز","نورآباد","پلدختر","ازنا","الشتر","چگنی","معمولان","سراب دوره","رومشگان","کونانی","چغابل"],
        "مازندران": ["ساری","بابل","آمل","قائم‌شهر","بابلسر","بهشهر","تنکاباد","نوشهر","چالوس","فریدون‌کنار","رامسر","نور","محمودآباد","نکا","جویبار","عباس‌آباد","سوادکوه","کلاردشت"],
        "مرکزی": ["اراک","ساوه","خمین","محلات","دلیجان","زرندیه","شازند","آشتیان","فراهان","تفرش","سربند","کمیجان","مهاجران","مأمونیه","نوبران"],
        "هرمزگان": ["بندرعباس","میناب","قشم","کیش","بندر لنگه","رودان","جاسک","بستک","حاجی‌آباد","پارسیان","سیریک","بشاگرد","کوهستک","تنگه","چارک","سندرک"],
        "همدان": ["همدان","ملایر","نهاوند","تویسرکان","اسدآباد","کبودراهنگ","بهار","رزن","فامنین","قروه درجزین","دمق","جوکار","ازندریان","سامن","جورقان","قهاوند"],
        "یزد": ["یزد","میبد","اردکان","تفت","بافق","ابرکوه","مهریز","اشکذر","هرات","شاهدیه","حمیدیا","زارچ","نیر","مروست","عقدا","بهاباد","احمدآباد","سایبان","خضرآباد","ندوشن"]
    };

    const weatherBackgrounds = {
        '01': 'bg-clear',
        '02': 'bg-clouds',
        '03': 'bg-clouds',
        '04': 'bg-clouds',
        '09': 'bg-rain',
        '10': 'bg-rain',
        '11': 'bg-thunderstorm',
        '13': 'bg-snow',
        '50': 'bg-mist'
    };

    const provinceSelect = document.getElementById('province-select');
    const citySelect = document.getElementById('city-select');
    const liveTimeElement = document.getElementById('live-time');
    const header = document.querySelector('header');
    const headerIcon = document.getElementById('header-icon');
    const headerMessage = document.getElementById('header-message');
    const currentData = document.getElementById('current-data');
    const forecastDiv = document.getElementById('forecast');
    const feedbackForm = document.getElementById('feedback-form');
    const commentsList = document.getElementById('comments-list');
    const currentCityTitle = document.getElementById('current-city-title');
    const loadingSpinner = document.getElementById('loading-spinner');
    const body = document.body;

    // Rain effect setup
    const rainContainer = document.createElement('div');
    rainContainer.className = 'rain hidden';
    document.body.appendChild(rainContainer);

    function createRaindrops() {
        if (!rainContainer.classList.contains('hidden')) {
            const drop = document.createElement('div');
            drop.className = 'drop';
            drop.style.left = `${Math.random() * 100}vw`;
            drop.style.width = `${Math.random() * 2 + 1}px`;
            drop.style.height = `${Math.random() * 40 + 20}px`;
            drop.style.animationDuration = `${Math.random() * 1 + 0.5}s`;
            drop.style.opacity = Math.random();
            rainContainer.appendChild(drop);
            setTimeout(() => drop.remove(), 1000); // Remove after animation
        }
    }

    let rainInterval = null;

    function startRainEffect() {
        if (!rainInterval) {
            rainContainer.classList.remove('hidden');
            rainInterval = setInterval(createRaindrops, 50);
        }
    }

    function stopRainEffect() {
        if (rainInterval) {
            clearInterval(rainInterval);
            rainInterval = null;
            rainContainer.classList.add('hidden');
        }
    }

    function isDay() {
        const hour = new Date().getHours();
        return hour >= 6 && hour < 20;
    }

    function updateLiveTime() {
        const now = new Date();
        const status = isDay() ? "روز" : "شب";
        liveTimeElement.textContent = `اکنون ${status} است, ${now.toLocaleDateString('fa-IR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        })}`;

        if (isDay()) {
            header.classList.remove('night-header');
        } else {
            header.classList.add('night-header');
        }
    }

    setInterval(updateLiveTime, 1000);
    updateLiveTime();

    function getPersianDate(timestamp) {
        const date = new Date(timestamp * 1000);
        return date.toLocaleDateString('fa-IR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    function getWeatherIconClass(iconCode) {
        const prefix = 'fa-';
        let iconClass = '';
        const dayNightCode = iconCode.slice(-1);

        switch (iconCode.substring(0, 2)) {
            case '01': // Clear sky
                iconClass = (dayNightCode === 'd') ? 'sun' : 'moon';
                break;
            case '02': // Few clouds
                iconClass = (dayNightCode === 'd') ? 'cloud-sun' : 'cloud-moon';
                break;
            case '03': // Scattered clouds
            case '04': // Broken clouds, overcast clouds
                iconClass = 'cloud';
                break;
            case '09': // Shower rain
            case '10': // Rain
                iconClass = (dayNightCode === 'd') ? 'cloud-sun-rain' : 'cloud-moon-rain';
                break;
            case '11': // Thunderstorm
                iconClass = 'cloud-bolt';
                break;
            case '13': // Snow
                iconClass = 'snowflake';
                break;
            case '50': // Mist
                iconClass = 'smog';
                break;
            default:
                iconClass = 'cloud';
        }
        return `${prefix}${iconClass}`;
    }

    function setDynamicBackground(iconCode) {
        const bgClass = weatherBackgrounds[iconCode.substring(0, 2)] || 'bg-clear';
        body.className = '';
        body.classList.add(bgClass);

        if (iconCode.substring(0, 2) === '09' || iconCode.substring(0, 2) === '10') {
            startRainEffect();
        } else {
            stopRainEffect();
        }
    }

    function getWindDirection(degrees) {
        const directions = ["شمال", "شمال شرق", "شرق", "جنوب شرق", "جنوب", "جنوب غرب", "غرب", "شمال غرب"];
        const index = Math.round(degrees / 45) % 8;
        return directions[index];
    }

    function populateDropdowns() {
        for (const province in provinces) {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            provinceSelect.appendChild(option);
        }

        provinceSelect.addEventListener('change', () => {
            const selectedProvince = provinceSelect.value;
            citySelect.innerHTML = '<option value="">شهر را انتخاب کنید</option>';
            citySelect.disabled = !selectedProvince;
            if (selectedProvince) {
                const uniqueCities = [...new Set(provinces[selectedProvince])].sort();
                uniqueCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
            clearWeatherDisplay();
        });
    }

    citySelect.addEventListener('change', () => {
        const selectedCity = citySelect.value;
        if (selectedCity) {
            currentCityTitle.innerHTML = `وضعیت فعلی در <span class="current-city-name">${selectedCity}</span>`;
            fetchCoordinates(selectedCity);
        } else {
            clearWeatherDisplay();
        }
    });

    function clearWeatherDisplay() {
        currentCityTitle.innerHTML = 'وضعیت فعلی';
        currentData.innerHTML = '<p>لطفاً یک استان و شهر را انتخاب کنید.</p>';
        forecastDiv.innerHTML = '';
        body.className = '';
        stopRainEffect();
        headerIcon.innerHTML = '';
        headerMessage.style.display = 'none';
    }

    async function fetchCoordinates(city) {
        loadingSpinner.classList.remove('hidden');
        currentData.innerHTML = '';
        forecastDiv.innerHTML = '';
        const geoUrl = `https://api.openweathermap.org/geo/1.0/direct?q=${city},IR&limit=1&appid=${API_KEY}`;
        try {
            const response = await fetch(geoUrl);
            const data = await response.json();
            if (data.length > 0) {
                const { lat, lon } = data[0];
                fetchWeather(lat, lon, city);
            } else {
                loadingSpinner.classList.add('hidden');
                currentData.innerHTML = `<p>مختصات برای شهر "${city}" یافت نشد. لطفاً شهر دیگری را انتخاب کنید.</p>`;
                forecastDiv.innerHTML = '';
            }
        } catch (error) {
            loadingSpinner.classList.add('hidden');
            currentData.innerHTML = `<p>خطا در دریافت مختصات: ${error.message}. لطفاً بعداً دوباره تلاش کنید.</p>`;
            forecastDiv.innerHTML = '';
            console.error('Error fetching coordinates:', error);
        }
    }

    function displayCurrentWeather(data, cityName) {
        loadingSpinner.classList.add('hidden');
        if (data.cod !== 200) {
            currentData.innerHTML = `<p>خطا در دریافت داده برای شهر: ${cityName || 'نامشخص'}</p>`;
            return;
        }

        const iconCode = data.weather[0].icon;
        const fontAwesomeIconClass = getWeatherIconClass(iconCode);
        const persianDate = getPersianDate(data.dt);
        const description = data.weather[0].description;
        const windSpeedKmH = Math.round(data.wind.speed * 3.6);
        const windDirection = getWindDirection(data.wind.deg);
        const sunriseTime = new Date(data.sys.sunrise * 1000).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        const sunsetTime = new Date(data.sys.sunset * 1000).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });

        setDynamicBackground(iconCode);

        // Update header icon and show message
        headerIcon.innerHTML = `<i class="fas ${fontAwesomeIconClass}"></i>`;
        headerMessage.style.display = 'block';

        currentData.innerHTML = `
            <div class="weather-icon">
                <i class="fas ${fontAwesomeIconClass}"></i>
            </div>
            <p><strong>تاریخ:</strong> ${persianDate}</p>
            <p><strong><span class="temp-color">دما:</span></strong> ${Math.round(data.main.temp)}°C</p>
            <p><strong><span class="feels-like-color">دمای محسوس:</span></strong> ${Math.round(data.main.feels_like)}°C</p>
            <p><strong>وضعیت:</strong> ${description}</p>
            <p><strong><span class="temp-min-max">حداقل/حداکثر دما:</span></strong> ${Math.round(data.main.temp_min)}°C / ${Math.round(data.main.temp_max)}°C</p>
            <p><strong><span class="humidity-color"><i class="fas fa-tint"></i> رطوبت:</span></strong> ${data.main.humidity}%</p>
            <p><strong><span class="wind-color"><i class="fas fa-wind"></i> سرعت باد:</span></strong> ${windSpeedKmH}km/h</p>
            <p><strong><span class="wind-direction-color"><i class="fas fa-compass"></i> جهت باد:</span></strong> ${windDirection}</p>
            <p><strong><span class="pressure-color"><i class="fas fa-arrow-down"></i> فشار هوا:</span></strong> ${data.main.pressure} hPa</p>
            <p><strong><span class="sunrise-color"><i class="fas fa-sun"></i> طلوع آفتاب:</span></strong> ${sunriseTime}</p>
            <p><strong><span class="sunset-color"><i class="fas fa-moon"></i> غروب آفتاب:</span></strong> ${sunsetTime}</p>
        `;
    }

    function displayForecast(data) {
        forecastDiv.innerHTML = '';
        const dailyForecasts = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        data.list.forEach(item => {
            const itemDate = new Date(item.dt * 1000);
            itemDate.setHours(0, 0, 0, 0);

            if (itemDate > today) {
                const dateStr = itemDate.toISOString().split('T')[0];
                if (!dailyForecasts[dateStr]) {
                    dailyForecasts[dateStr] = {
                        temps: [],
                        humidity: [],
                        windSpeed: [],
                        pop: [],
                        description: item.weather[0].description,
                        icon: item.weather[0].icon,
                        date: item.dt
                    };
                }
                dailyForecasts[dateStr].temps.push(item.main.temp);
                dailyForecasts[dateStr].humidity.push(item.main.humidity);
                dailyForecasts[dateStr].windSpeed.push(item.wind.speed);
                dailyForecasts[dateStr].pop.push(item.pop);
            }
        });

        const sortedDates = Object.keys(dailyForecasts).sort();
        const futureDays = sortedDates.slice(0, 5);

        if (futureDays.length === 0) {
            forecastDiv.innerHTML = `<p>پیش‌بینی ۵ روزه موجود نیست.</p>`;
            return;
        }

        futureDays.forEach(dateStr => {
            const forecast = dailyForecasts[dateStr];
            const minTemp = Math.round(Math.min(...forecast.temps));
            const maxTemp = Math.round(Math.max(...forecast.temps));
            const avgHumidity = Math.round(forecast.humidity.reduce((a, b) => a + b, 0) / forecast.humidity.length);
            const avgWindSpeed = Math.round((forecast.windSpeed.reduce((a, b) => a + b, 0) / forecast.windSpeed.length) * 3.6);
            const maxPop = Math.round(Math.max(...forecast.pop) * 100);

            const date = new Date(forecast.date * 1000).toLocaleDateString('fa-IR', { weekday: 'long' });
            const persianDate = getPersianDate(forecast.date);
            const fontAwesomeIconClass = getWeatherIconClass(forecast.icon);

            const card = document.createElement('div');
            card.classList.add('forecast-card');
            card.innerHTML = `
                <h4>${date}</h4>
                <p>${persianDate}</p>
                <div class="weather-icon">
                    <i class="fas ${fontAwesomeIconClass}"></i>
                </div>
                <p><strong>وضعیت:</strong> ${forecast.description}</p>
                <p><strong><span class="temp-min-max">حداقل/حداکثر دما:</span></strong> ${minTemp}°C / ${maxTemp}°C</p>
                <p><strong><span class="humidity-color"><i class="fas fa-tint"></i> رطوبت:</span></strong> ${avgHumidity}%</p>
                <p><strong><span class="wind-color"><i class="fas fa-wind"></i> سرعت باد:</span></strong> ${avgWindSpeed}km/h</p>
                <p><strong><span class="pop-color"><i class="fas fa-cloud-showers-heavy"></i> احتمال بارش:</span></strong> ${maxPop}%</p>
            `;
            forecastDiv.appendChild(card);
        });
    }

    async function fetchWeather(lat, lon, city) {
        loadingSpinner.classList.remove('hidden');
        currentData.innerHTML = '';
        forecastDiv.innerHTML = '';
        const currentUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=fa`;
        const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=fa`;

        try {
            const [currentResponse, forecastResponse] = await Promise.all([
                fetch(currentUrl),
                fetch(forecastUrl)
            ]);

            if (!currentResponse.ok) {
                throw new Error(`Current weather data fetch failed with status: ${currentResponse.status}`);
            }
            if (!forecastResponse.ok) {
                throw new Error(`Forecast data fetch failed with status: ${forecastResponse.status}`);
            }

            const currentDataResponse = await currentResponse.json();
            const forecastDataResponse = await forecastResponse.json();

            displayCurrentWeather(currentDataResponse, city);
            displayForecast(forecastDataResponse);

        } catch (error) {
            currentData.innerHTML = `<p>خطا در دریافت داده‌های هواشناسی: ${error.message}. لطفاً بعداً دوباره تلاش کنید.</p>`;
            forecastDiv.innerHTML = '';
            console.error('Error fetching weather data:', error);
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    }

    function loadComments() {
        const comments = JSON.parse(localStorage.getItem('weather_comments')) || [];
        commentsList.innerHTML = '';
        comments.forEach(comment => {
            const li = document.createElement('li');
            li.innerHTML = `
                <strong>${comment.name}</strong>
                <p>${comment.comment}</p>
                <small>${comment.date}</small>
            `;
            commentsList.appendChild(li);
        });
    }

    feedbackForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('feedback-name').value.trim();
        const comment = document.getElementById('feedback-comment').value.trim();

        if (!name || !comment) {
            alert('لطفاً نام و نظر خود را وارد کنید.');
            return;
        }

        const date = new Date().toLocaleDateString('fa-IR', {
            year: 'numeric', month: 'long', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });

        const newComment = { name, comment, date };
        const comments = JSON.parse(localStorage.getItem('weather_comments')) || [];
        comments.push(newComment);
        localStorage.setItem('weather_comments', JSON.stringify(comments));

        feedbackForm.reset();
        loadComments();
    });

    document.addEventListener('DOMContentLoaded', () => {
        populateDropdowns();
        loadComments();
    });
</script>
</body>
</html>
