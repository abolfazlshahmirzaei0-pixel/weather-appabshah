<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هواشناسی هوشمند ابوالفضل شاهمیرزایی</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        :root { --p: #3b82f6; --s: #8b5cf6; --bg-d: #f8fafc; --bg-n: #0f172a; }
        * { box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: 0.5s; }
        body.day-mode { background: var(--bg-d); color: #1e293b; }
        body.night-mode { background: var(--bg-n); color: #f8fafc; }

        header { width: 100%; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; background: rgba(128,128,128,0.15); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(128,128,128,0.2); z-index: 1000; }
        .scroll-v { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }

        #login-overlay { position: fixed; inset: 0; z-index: 9999; background: linear-gradient(135deg, #1e3a8a, #3b82f6); display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 30px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }

        .glass { background: rgba(255,255,255,0.9); border-radius: 25px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }
        .night-mode .glass { background: rgba(30, 41, 59, 0.95); }

        .temp-row { direction: ltr; font-size: 5.5rem; font-weight: 900; color: var(--p); display: inline-block; }
        input, select, textarea { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #ddd; font-family: inherit; font-size: 1rem; }
        .btn { background: var(--p); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-red { background: #ef4444; width: auto; padding: 6px 15px; margin-right: 10px; }

        .f-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 20px; }
        .f-card { background: rgba(59,130,246,0.1); padding: 15px; border-radius: 20px; text-align: center; border: 1px solid rgba(59,130,246,0.1); }
        .unit { font-size: 0.9rem; color: var(--p); font-weight: bold; margin-right: 3px; }
    </style>
</head>
<body class="day-mode">

<div id="login-overlay">
    <div class="login-card">
        <h2 style="color:var(--p); margin:0">سامانه هواشناسی</h2>
        <p>سازنده: <b>ابوالفضل شاهمیرزایی</b></p>
        <input type="text" id="fn" placeholder="نام">
        <input type="text" id="ln" placeholder="نام خانوادگی">
        <button class="btn" onclick="login()">ورود به پنل</button>
    </div>
</div>

<header id="h-ui" style="display:none">
    <div style="display:flex; align-items:center">
        <button class="btn btn-red" onclick="logout()"><i class="fa fa-power-off"></i> خروج</button>
        <b id="u-display" style="background:var(--p); color:white; padding:5px 15px; border-radius:20px;"></b>
    </div>
    <div style="text-align:center">
        <div id="clock" style="font-weight:900; color:var(--p); font-size:1.3rem;">۰۰:۰۰:۰۰</div>
        <small id="date-fa"></small>
    </div>
    <div id="m-icon" style="font-size:1.5rem">☀️</div>
</header>

<div class="scroll-v" id="main-ui" style="display:none">
    <div style="max-width: 850px; margin: 0 auto;">
        
        <div class="glass">
            <div style="display:flex; gap:10px">
                <select id="p-sel" onchange="loadC()"><option value="">انتخاب استان (۳۱ استان)...</option></select>
                <select id="c-sel" onchange="fetchData()"><option>انتخاب شهر...</option></select>
            </div>
        </div>

        <div id="weather-data" style="display:none">
            <div class="glass" style="text-align:center">
                <h1 id="r-city" style="margin:0; font-size:2.5rem"></h1>
                <div id="r-icon"></div>
                <div class="temp-row"><span id="r-temp"></span><span style="font-size:2rem">°C</span></div>
                <p id="r-desc" style="font-size:1.5rem; font-weight:bold; color:var(--p)"></p>
                
                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; margin-top:25px">
                    <div class="f-card">باد: <b id="v-w"></b><span class="unit">km/h</span></div>
                    <div class="f-card">رطوبت: %<b id="v-h"></b></div>
                    <div class="f-card">فشار: <b id="v-p"></b><span class="unit">hPa</span></div>
                    <div class="f-card">دید: <b id="v-v"></b><span class="unit">km</span></div>
                </div>
            </div>

            <div class="glass" style="border-right:8px solid var(--s)">
                <h3 style="color:var(--s); margin:0">تحلیل ابوالفضل AI:</h3>
                <p id="ai-msg" style="line-height:1.8; text-align:justify"></p>
            </div>

            <div class="glass">
                <h3 style="margin:0">پیش‌بینی ۵ روزه گرافیکی</h3>
                <div class="f-grid" id="f-grid"></div>
            </div>
        </div>

        <div class="glass">
            <h4>گزارشات و نظرات</h4>
            <textarea id="c-input" rows="3" placeholder="متن خود را اینجا بنویسید..."></textarea>
            <button class="btn" onclick="saveC()">ثبت گزارش</button>
            <div id="c-list" style="margin-top:20px"></div>
        </div>

        <p style="text-align:center; opacity:0.6; padding:20px">طراحی شده توسط: ابوالفضل شاهمیرزایی</p>
    </div>
</div>

<script>
    const API = 'bf8755006c2fc6e2762533c174860bf6';
    const toFa = n => n.toString().replace(/\d/g, x => ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'][x]);

    // دیتابیس کامل ۳۱ استان - هر کدام ۲۵ شهر
    const DB_FULL = {
        "آذربایجان شرقی": ["تبریز", "مراغه", "مرند", "میانه", "اهر", "بناب", "سراب", "آذرشهر", "هریس", "عجب‌شیر", "ملکان", "کلیبر", "جلفا", "شبستر", "هشترود", "ورزقان", "اسکو", "بستان‌آباد", "تسنوج", "گوگان", "ممقان", "صوفیان", "ایلخچی", "خسروشاه", "سهند"],
        "آذربایجان غربی": ["ارومیه", "خوی", "بوکان", "مهاباد", "سلماس", "نقده", "پیرانشهر", "تکاب", "ماکو", "سردشت", "شاهین‌دژ", "اشنویه", "قره‌ضیاء", "شوط", "پلدشت", "بازرگان", "تازه‌شهر", "محمدیار", "فیرورق", "نالوس", "باروق", "کشاورز", "میرآباد", "سیاه چشمه"],
        "اردبیل": ["اردبیل", "پارس‌آباد", "مشگین‌شهر", "خلخال", "گرمی", "نمین", "بیله‌سوار", "سرعین", "گیوی", "نیر", "عنبران", "هشتجین", "لاهرود", "تازه‌کند", "اسلام‌آباد", "قصابه", "مرادلو", "فخرآباد", "آبی‌بیگلو", "ثمرین", "کوراییم", "ایردیموسی", "جعفرآباد", "انگوت"],
        "اصفهان": ["اصفهان", "کاشان", "خمینی‌شهر", "نجف‌آباد", "شاهین‌شهر", "شهرضا", "مبارکه", "زرین‌شهر", "گلپایگان", "فریدون‌شهر", "سمیرم", "خوانسار", "نائین", "نطنز", "اردستان", "خور", "تیران", "دهاقان", "فولادشهر", "هرند", "ورزنه", "پیربکران", "درچه", "کوشک"],
        "البرز": ["کرج", "فردیس", "کمال‌شهر", "نظرآباد", "محمدشهر", "ماهدشت", "هشتگرد", "اشتهارد", "طالقان", "چهارباغ", "کوهسار", "تنکمان", "آسارا", "پلنگ‌آباد", "گلسار", "سعیدآباد", "مهدی‌آباد", "خور", "رستمی", "بختیار", "دنگیزک", "هیو", "زعفرانیه", "سهیلیه"],
        "ایلام": ["ایلام", "دهلران", "ایوان", "آبدانان", "دره‌شهر", "مهران", "سرابله", "ارکواز", "بدره", "چوار", "دلگشا", "آسمان‌آباد", "میمک", "موسبان", "هلیلان", "صالح‌آباد", "پهله", "مورموری", "سراب‌باغ", "توحید", "شباب", "بلاوه", "مهر", "پهله"],
        "بوشهر": ["بوشهر", "برازجان", "گناوه", "کنگان", "عسلویه", "جم", "خورموج", "دیلم", "دیر", "آبدان", "خارک", "شبانکاره", "اهرم", "دلوار", "بادوله", "نخل تقی", "وحدتیه", "سعدآباد", "آب‌پخش", "بردستان", "کاکی", "تنگ ارم", "سیراف", "چغادک", "نخل تقی"],
        "تهران": ["تهران", "شهریار", "اسلامشهر", "ورامین", "ملارد", "قدس", "پاکدشت", "ری", "قرچک", "پردیس", "بومهن", "دماوند", "رباط‌کریم", "لواسان", "فشم", "تجریش", "باقرشهر", "چهاردانگه", "صبا شهر", "وحیدیه", "اندیشه", "نصیرشهر", "فردوسیه", "شاهدشهر", "پیشوا"],
        "چهارمحال و بختیاری": ["شهرکرد", "بروجن", "لردگان", "فرخ‌شهر", "فارسان", "هفشجان", "جونقان", "بن", "سامان", "کیان", "بلداجی", "فرادنبه", "باباحیدر", "سفیددشت", "آلونی", "وردنجان", "شلمزار", "گهرو", "دشتک", "نقنه", "چلیچه", "گوجان", "سرخون", "مال‌خلیفه"],
        "خراسان جنوبی": ["بیرجند", "قائن", "طبس", "فردوس", "نهبندان", "بشرویه", "سرایان", "سربیشه", "خضری", "اسدیه", "نیمبلوک", "آرین‌شهر", "مود", "شوسف", "ارسک", "دیهوک", "سه‌قلعه", "عشق‌آباد", "گزیک", "طبس مسینا", "قهستان", "درح", "آیسک", "درح"],
        "خراسان رضوی": ["مشهد", "نیشابور", "سبزوار", "تربت حیدریه", "قوچان", "کاشمر", "چناران", "تربت جام", "تایباد", "گناباد", "فریمان", "سرخس", "درگز", "بردسکن", "خواف", "فیض‌آباد", "نقاب", "بجستان", "شاندیز", "طرقبه", "خلیل‌آباد", "جوین", "کدکن", "داورزن"],
        "خراسان شمالی": ["بجنورد", "شیروان", "اسفراین", "آشخانه", "جاجرم", "فاروج", "گرمه", "راز", "ایور", "تیتکانلو", "درق", "زیارت", "سنخواست", "شوقان", "صفی‌آباد", "حصارگرمخان", "لوجلی", "قاضی", "پیش‌قلعه", "غلامان", "یکه‌سعود", "آوا", "راز"],
        "خوزستان": ["اهواز", "دزفول", "آبادان", "خرمشهر", "ماهشهر", "اندیمشک", "ایذه", "بهبهان", "شوشتر", "شوش", "مسجدسلیمان", "امیدیه", "شادگان", "رامشیر", "باغ‌ملک", "هندیجان", "لالی", "هویزه", "ویس", "گتوند", "حمیدیه", "ملاشیه", "بستان", "هفتکل"],
        "زنجان": ["زنجان", "ابهر", "خرمدره", "قیدار", "هیدج", "صائین‌قلعه", "آب‌بر", "سلطانیه", "ماهنشان", "چورزق", "زرین‌آباد", "ارمغان‌خانه", "کرسف", "سجاس", "زرین‌رود", "نوربهار", "سهرورد", "حلب", "نیک‌پی", "دندی", "گیوان", "پری", "دستجرد"],
        "سمنان": ["سمنان", "شاهرود", "دامغان", "گرمسار", "مهدی‌شهر", "ایوانکی", "سرخه", "شهمیرزاد", "بسطام", "آرادان", "مججن", "کلاته خیج", "بیارجمند", "رودیان", "درجزین", "امیریه", "دیباج", "کلاته رودبار", "کهن‌آباد", "سطوه", "طرود", "شاهرود", "بیارجمند"],
        "سیستان و بلوچستان": ["زاهدان", "زابل", "ایرانشهر", "چابهار", "سراوان", "خاش", "کنارک", "نیک‌شهر", "پیشین", "زهک", "فنوج", "بمپور", "قصرقند", "راسک", "ادیمی", "بنت", "بزمان", "گلمورتی", "نوک‌آباد", "جالق", "سیرکان", "هیدوج", "نگور", "سراوان"],
        "فارس": ["شیراز", "مرودشت", "جهرم", "فسا", "کازرون", "داراب", "لار", "نی‌ریز", "اقلید", "سپیدان", "استهبان", "فیروزآباد", "آباده", "لامرد", "کوار", "زرین‌دشت", "قائمیه", "نورآباد", "خنج", "گراش", "سروستان", "بوانات", "خرامه", "صفاشهر"],
        "قزوین": ["قزوین", "الوند", "تاکستان", "آبیک", "محمدیه", "بیدستان", "اقبالیه", "شال", "اسفرورین", "ضیاءآباد", "خرمدشت", "نرجه", "سگزآباد", "ارداق", "آوج", "آبگرم", "سیردان", "رازمیان", "معلم‌کلایه", "کوهین", "بوین‌زهرا", "شریفیه", "محمودآباد"],
        "قم": ["قم", "قنوات", "جعفریه", "کهک", "دستجرد", "سلفچگان", "پردیسان", "جمکران", "شکوهیه", "میم", "فردوی", "وشنوه", "نایه", "قلعه‌چم", "صنعت‌شهر", "طایقان", "ونارچ", "خاوه", "ورجان", "سیرو", "نیه", "امامزاده", "تاج خاتون", "بستک"],
        "کردستان": ["سنندج", "سقز", "مریوان", "بانه", "قروه", "کامیاران", "بیجار", "دیواندره", "دهگلان", "سروآباد", "سریش‌آباد", "دلبران", "یاسوکند", "موچش", "اورامان تخت", "صاحب", "آرمرده", "دزج", "زرینه", "کانی‌سور", "بلبان‌آباد", "پیرتاج", "شویشه", "بابارشانی"],
        "کرمان": ["کرمان", "سیرجان", "رفسنجان", "جیرفت", "بم", "زرند", "کهنوج", "شهربابک", "بافت", "بردسیر", "راور", "عنبرآباد", "منوجان", "قلعه‌گنج", "ماهان", "نجف‌شهر", "ارزوئیه", "بزنجان", "درب بهشت", "فهرج", "ریگان", "کشکوئیه", "جوزم", "یزدان‌شهر"],
        "کرمانشاه": ["کرمانشاه", "اسلام‌آباد غرب", "جوانرود", "کنگاور", "سرپل ذهاب", "سنقر", "هرسین", "صحنه", "پاوه", "گیلانغرب", "روانسر", "تازه‌آباد", "کرند غرب", "بیستون", "گهواره", "کوزران", "ریجاب", "نوسود", "حمیل", "باینگان", "ازگله", "سومار", "شاهو", "نودشه"],
        "کهگیلویه و بویراحمد": ["یاسوج", "دوگنبدان", "دهدشت", "لیکک", "مادوان", "لنده", "سی‌سخت", "چرام", "باشت", "پاتاوه", "قلعه رئیسی", "دیشموک", "سوق", "بوستان", "مارگون", "گراب سفلی", "سرفاریاب", "چیتاب", "لوداب", "ممبی", "سرآسیاب", "دیشموک", "قلعه رئیسی"],
        "گلستان": ["گرگان", "گنبد کاووس", "بندر ترکمن", "علی‌آباد کتول", "آزادشهر", "کردکوی", "کلاله", "آق‌قلا", "مینودشت", "گالیکش", "بندر گز", "گمیشان", "فاضل‌آباد", "خان‌ببین", "دلند", "رامیان", "سرخنکلاته", "سیمین‌شهر", "مراوه‌تپه", "انبار آلوم", "تاتار علیا", "نوکنده"],
        "گیلان": ["رشت", "بندر انزلی", "لاهیجان", "لنگرود", "رودسر", "تالش", "آستارا", "صومعه‌سرا", "آستانه اشرفیه", "فومن", "ماسال", "رودبار", "سیاهکل", "املش", "کیاشهر", "منجیل", "لوشان", "رضوانشهر", "شفت", "اسالم", "پره‌سر", "خشکبیجار", "خمام", "چاف"],
        "لرستان": ["خرم‌آباد", "بروجرد", "دورود", "کوهدشت", "الیگودرز", "الشتر", "نورآباد", "ازنا", "پلدختر", "کونانی", "معمولان", "چقادمبل", "اشترینان", "فیروزآباد", "گراب", "سپیددشت", "زاغه", "چالانچولان", "درب گنبد", "سراب‌دوره", "شول‌آباد", "هفت چشمه", "مومن‌آباد"],
        "مازندران": ["ساری", "بابل", "آمل", "قائم‌شهر", "بهشهر", "چالوس", "نوشهر", "نور", "رامسر", "تنکابن", "بابلسر", "نکا", "محمودآباد", "فریدون‌کنار", "جویبار", "گلوگاه", "کتالم", "سلمان‌شهر", "کلاردشت", "امیرکلا", "چمستان", "هچیرود", "شیرگاه", "کلاردشت"],
        "مرکزی": ["اراک", "ساوه", "خمین", "محلات", "دلیجان", "شازند", "تفرش", "آشتیان", "کمیجان", "نیمور", "فرمهین", "زاویه", "نراق", "خنداب", "غرق‌آباد", "پرندک", "مأمونیه", "خشکرود", "میلاجرد", "جاورسیان", "کارچان", "توره", "ساروق", "هندودر"],
        "هرمزگان": ["بندرعباس", "قشم", "کیش", "میناب", "دهبارز", "بندر لنگه", "بندر جاسک", "حاجی‌آباد", "بندر خمیر", "پارسیان", "بستک", "هرمز", "فین", "رویدر", "بیکاه", "قلعه قاضی", "تخت", "درگهان", "کوشکنار", "تیرور", "سندرک", "ابوموسی", "بندر چارک", "گروک"],
        "همدان": ["همدان", "ملایر", "نهاوند", "تویسرکان", "اسدآباد", "کبودرآهنگ", "بهار", "رزن", "فامنین", "لالجین", "مریانج", "ازندریان", "قروه درجزین", "گیان", "صالح‌آباد", "مهاجران", "برزول", "فیروزان", "سامن", "سرکان", "دمق", "اجین", "گل‌تپه", "شیرین‌سو"],
        "یزد": ["یزد", "میبد", "اردکان", "بافق", "مهریز", "ابرکوه", "تفت", "اشکذر", "هرات", "بهاباد", "مروست", "حمیدیا", "شاهدیه", "مجومرد", "بخ", "عقدا", "نیر", "خضرآباد", "بفروئیه", "ندوشن", "احمدآباد", "مهردشت", "بافق", "تفت"]
    };

    function login() {
        const f = document.getElementById('fn').value;
        const l = document.getElementById('ln').value;
        if(f && l) { localStorage.setItem('ab_name', f+' '+l); location.reload(); }
    }
    function logout() { localStorage.removeItem('ab_name'); location.reload(); }

    function loadC() {
        const p = document.getElementById('p-sel').value;
        const cS = document.getElementById('c-sel');
        cS.innerHTML = '<option>انتخاب شهر...</option>';
        if(DB_FULL[p]) DB_FULL[p].sort().forEach(c => cS.add(new Option(c, c)));
    }

    async function fetchData() {
        const city = document.getElementById('c-sel').value;
        if(city.includes('انتخاب')) return;
        const proxy = "https://corsproxy.io/?";
        try {
            const [r1, r2] = await Promise.all([
                fetch(`${proxy}${encodeURIComponent(`https://api.openweathermap.org/data/2.5/weather?q=${city},IR&appid=${API}&units=metric&lang=fa`)}`),
                fetch(`${proxy}${encodeURIComponent(`https://api.openweathermap.org/data/2.5/forecast?q=${city},IR&appid=${API}&units=metric&lang=fa`)}`)
            ]);
            updateUI(await r1.json(), await r2.json(), city);
        } catch(e) { alert("خطا در اتصال به سرور"); }
    }

    function updateUI(d, f, city) {
        document.getElementById('weather-data').style.display = 'block';
        document.getElementById('r-city').innerText = city;
        let t = Math.round(d.main.temp);
        document.getElementById('r-temp').innerText = toFa(t);
        document.getElementById('r-desc').innerText = d.weather[0].description;
        document.getElementById('r-icon').innerHTML = `<img src="https://openweathermap.org/img/wn/${d.weather[0].icon}@4x.png" width="120">`;
        
        document.getElementById('v-w').innerText = toFa(Math.round(d.wind.speed * 3.6));
        document.getElementById('v-h').innerText = toFa(d.main.humidity);
        document.getElementById('v-p').innerText = toFa(d.main.pressure);
        document.getElementById('v-v').innerText = toFa((d.visibility/1000).toFixed(1));

        const u = localStorage.getItem('ab_name').split(' ')[0];
        document.getElementById('ai-msg').innerText = `جناب ${u}؛ واکاوی ابوالفضل AI نشان می‌دهد در ${city} دما ${toFa(t)}°C است. فشار جو ${toFa(d.main.pressure)} hPa و رطوبت ${toFa(d.main.humidity)}٪ گزارش شده است.`;

        const grid = document.getElementById('f-grid'); grid.innerHTML = '';
        f.list.filter(x => x.dt_txt.includes("12:00:00")).forEach(day => {
            grid.innerHTML += `<div class="f-card">
                <small>${new Date(day.dt*1000).toLocaleDateString('fa-IR', {weekday:'short'})}</small><br>
                <img src="https://openweathermap.org/img/wn/${day.weather[0].icon}.png" width="40"><br>
                <b>${toFa(Math.round(day.main.temp))}°C</b></div>`;
        });
    }

    function saveC() {
        const text = document.getElementById('c-input').value; if(!text) return;
        const list = JSON.parse(localStorage.getItem('ab_coms') || '[]');
        list.unshift({ u: localStorage.getItem('ab_name'), t: text });
        localStorage.setItem('ab_coms', JSON.stringify(list.slice(0, 5)));
        document.getElementById('c-input').value = ''; showC();
    }
    function showC() {
        const list = JSON.parse(localStorage.getItem('ab_coms') || '[]');
        document.getElementById('c-list').innerHTML = list.map(c => `<div style="padding:10px; border-bottom:1px solid #eee"><b>${c.u}:</b> ${c.t}</div>`).join('');
    }

    window.onload = () => {
        const user = localStorage.getItem('ab_name');
        if(user) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('h-ui').style.display = 'flex';
            document.getElementById('main-ui').style.display = 'block';
            document.getElementById('u-display').innerText = user;
            Object.keys(DB_FULL).sort().forEach(p => document.getElementById('p-sel').add(new Option(p,p)));
            showC();
        }
        setInterval(() => {
            const n = new Date();
            document.body.className = (n.getHours()>=18 || n.getHours()<6) ? 'night-mode' : 'day-mode';
            document.getElementById('clock').innerText = toFa(n.toLocaleTimeString('fa-IR'));
            document.getElementById('date-fa').innerText = n.toLocaleDateString('fa-IR', {dateStyle:'full'});
        }, 1000);
    };
</script>
</body>
</html>
