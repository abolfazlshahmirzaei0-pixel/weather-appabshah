<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>فهرست شهرها و استان‌های ایران</title>
  <style>
    body { font-family: Tahoma, sans-serif; direction: rtl; margin: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    input, select, textarea { padding: 6px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    .filter-container { margin-bottom: 15px; }
    .weather { margin-top: 10px; }
    footer { margin-top: 30px; font-size: 12px; color: #555; text-align: center; }
    button { padding: 8px 12px; cursor: pointer; }
  </style>
</head>
<body>

<h1>فهرست شهرها و استان‌های ایران</h1>

<div class="filter-container">
  <label for="provinceFilter">انتخاب استان:</label>
  <select id="provinceFilter">
    <option value="">همه استان‌ها</option>
  </select>

  <label for="citySearch">جستجوی شهر:</label>
  <input type="text" id="citySearch" placeholder="نام شهر را وارد کنید...">
</div>

<table id="cityTable">
  <thead>
    <tr>
      <th>استان</th>
      <th>شهر</th>
      <th>دمای فعلی (°C)</th>
      <th>وضعیت آب و هوا</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>ثبت نظر</h2>
<form id="commentForm">
  <label for="name">نام:</label>
  <input type="text" id="name" required>
  
  <label for="comment">نظر شما:</label>
  <textarea id="comment" required></textarea>
  
  <button type="submit">ارسال نظر</button>
</form>

<div id="commentsList"></div>

<footer>
  ساخته شده توسط ابوالفضل شاهمیرزایی - سال ۱۴۰۴ | ساعت: <span id="currentTime"></span>
</footer>

<script>
const apiKey = "64231bdfdeaa541bbee0be4c1868c100";

// بارگذاری JSON شهرها و استان‌ها
let cities = [];
let provinces = {};
fetch('irancities.json')
  .then(res => res.json())
  .then(data => {
    cities = data.cities;
    provinces = data.provinces.reduce((acc, p) => { acc[p.id] = p.name; return acc; }, {});
    populateProvinceFilter();
    displayCities();
  });

// پر کردن فیلتر استان
function populateProvinceFilter() {
  const select = document.getElementById('provinceFilter');
  for (let id in provinces) {
    const option = document.createElement('option');
    option.value = id;
    option.textContent = provinces[id];
    select.appendChild(option);
  }
}

// نمایش شهرها در جدول
function displayCities() {
  const tbody = document.querySelector('#cityTable tbody');
  tbody.innerHTML = '';
  const search = document.getElementById('citySearch').value.trim();
  const provinceId = document.getElementById('provinceFilter').value;

  let filtered = cities.filter(city => {
    return (!provinceId || city.ostan == provinceId) &&
           (!search || city.name.includes(search));
  });

  filtered.forEach(city => {
    const tr = document.createElement('tr');
    const tdProvince = document.createElement('td');
    tdProvince.textContent = provinces[city.ostan];
    const tdCity = document.createElement('td');
    tdCity.textContent = city.name;
    const tdTemp = document.createElement('td');
    const tdWeather = document.createElement('td');
    tdTemp.textContent = 'در حال بارگذاری...';
    tdWeather.textContent = 'در حال بارگذاری...';

    tr.appendChild(tdProvince);
    tr.appendChild(tdCity);
    tr.appendChild(tdTemp);
    tr.appendChild(tdWeather);
    tbody.appendChild(tr);

    // گرفتن اطلاعات آب و هوا
    fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city.name},IR&units=metric&appid=${apiKey}`)
      .then(res => res.json())
      .then(w => {
        tdTemp.textContent = w.main ? w.main.temp.toFixed(1) : '-';
        tdWeather.textContent = w.weather ? w.weather[0].description : '-';
      })
      .catch(() => {
        tdTemp.textContent = '-';
        tdWeather.textContent = '-';
      });
  });
}

// فیلتر و جستجو
document.getElementById('provinceFilter').addEventListener('change', displayCities);
document.getElementById('citySearch').addEventListener('input', displayCities);

// ساعت زنده
function updateTime() {
  const now = new Date();
  document.getElementById('currentTime').textContent = now.toLocaleString('fa-IR');
}
setInterval(updateTime, 1000);
updateTime();

// فرم نظرات
const commentsList = document.getElementById('commentsList');
document.getElementById('commentForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const comment = document.getElementById('comment').value.trim();
  if (name && comment) {
    const div = document.createElement('div');
    div.style.borderTop = '1px solid #ccc';
    div.style.padding = '5px';
    div.innerHTML = `<strong>${name}</strong>: ${comment}`;
    commentsList.prepend(div);
    this.reset();
  }
});
</script>

</body>
</html>
