<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سامانه هواشناسی فوق هوشمند | نسخه جامع</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        :root { --p: #0284c7; --s: #7c3aed; --bg-d: #f8fafc; --bg-n: #0f172a; }
        * { box-sizing: border-box; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        body { font-family: 'Vazirmatn', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        body.day-mode { background: var(--bg-d); color: #1e293b; }
        body.night-mode { background: var(--bg-n); color: #f8fafc; }

        header { width: 100%; padding: 12px 5%; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(128,128,128,0.2); z-index: 1000; }
        .scroll-v { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }

        .glass { background: rgba(255,255,255,0.8); border-radius: 28px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.04); border: 1px solid rgba(255,255,255,0.3); }
        .night-mode .glass { background: rgba(30, 41, 59, 0.7); border-color: rgba(255,255,255,0.05); }

        .ai-box { border-right: 6px solid var(--s); background: linear-gradient(90deg, transparent, rgba(124, 58, 237, 0.05)) !important; }
        select, input, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 14px; border: 1px solid #ddd; font-family: inherit; background: white; }
        .btn { background: var(--p); color: white; border: none; padding: 14px; border-radius: 14px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        
        #ai-reply-box { margin-top: 15px; padding: 15px; border-radius: 15px; background: rgba(124, 58, 237, 0.1); display: none; border: 1px dashed var(--s); }
    </style>
</head>
<body class="day-mode">

<div id="login-overlay" style="position:fixed; inset:0; z-index:9999; background:#0f172a; display:flex; align-items:center; justify-content:center;">
    <div class="glass" style="max-width:380px; text-align:center;">
        <h2 style="color:var(--p)">خوش آمدید</h2>
        <input type="text" id="fn" placeholder="نام">
        <input type="text" id="ln" placeholder="نام خانوادگی">
        <button class="btn" onclick="login()">ورود به پنل هوشمند</button>
    </div>
</div>

<header id="h-ui" style="display:none">
    <div style="display:flex; align-items:center; gap:12px">
        <button onclick="logout()" style="background:#ef4444; border:none; color:white; padding:8px 12px; border-radius:12px; cursor:pointer"><i class="fa fa-power-off"></i></button>
        <b id="u-display"></b>
    </div>
    <div style="text-align:center">
        <div id="clock" style="font-weight:900; color:var(--p); font-size:1.4rem;">۰۰:۰۰:۰۰</div>
        <small id="date-fa" style="opacity:0.6"></small>
    </div>
    <div id="m-icon">☀️</div>
</header>

<div class="scroll-v" id="main-ui" style="display:none">
    <div style="max-width: 800px; margin: 0 auto;">
        
        <div class="glass">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                <select id="p-sel" onchange="loadCities()"><option value="">استان را انتخاب کنید...</option></select>
                <select id="c-sel" onchange="getWeather()"><option>شهر را انتخاب کنید...</option></select>
            </div>
        </div>

        <div id="result" style="display:none">
            <div class="glass" style="text-align:center">
                <h1 id="city-name" style="margin:0; font-size:2.5rem"></h1>
                <div id="icon"></div>
                <div style="font-size:4rem; font-weight:900; color:var(--p); direction:ltr"><span id="temp"></span>°C</div>
                <p id="desc" style="font-size:1.2rem; font-weight:bold"></p>
            </div>

            <div class="glass ai-box">
                <h3 style="color:var(--s); margin:0"><i class="fa fa-robot"></i> تحلیلگر هوشمند اتمسفر:</h3>
                <p id="ai-text" style="line-height:1.8; text-align:justify"></p>
                
                <div style="margin-top:20px; border-top:1px solid #ddd; padding-top:15px">
                    <p style="font-size:0.9rem"><b>از من بپرس:</b> (مثلاً: فردا بارانی است؟ یا چه بپوشم؟)</p>
                    <div style="display:flex; gap:8px">
                        <input type="text" id="ai-q" placeholder="سوال خود را بنویسید..." style="margin:0">
                        <button class="btn" style="width:80px" onclick="askAI()">بپرس</button>
                    </div>
                    <div id="ai-reply-box"></div>
                </div>
            </div>
        </div>
        
        <p style="text-align:center; opacity:0.4; padding:20px">توسعه یافته توسط ابوالفضل شاهمیرزایی</p>
    </div>
</div>

<script>
    const key = 'bf8755006c2fc6e2762533c174860bf6';
    const toFa = n => n.toString().replace(/\d/g, x => ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'][x]);

    // دیتابیس جامع ۳۱ استان و شهرهای کلیدی (ساختار برای ۶۰۰ شهر آماده است)
    const DB = {
        "آذربایجان شرقی": ["تبریز", "مراغه", "مرند", "میانه", "اهر", "بناب", "سراب", "آذرشهر", "هریس", "عجب‌شیر", "ملکان", "کلیبر", "جلفا", "شبستر", "هشترود", "ورزقان", "اسکو", "بستان‌آباد"],
        "آذربایجان غربی": ["ارومیه", "خوی", "بوکان", "مهاباد", "سلماس", "نقده", "پیرانشهر", "تکاب", "ماکو", "سردشت", "شاهین‌دژ", "اشنویه", "قره‌ضیاءالدین", "شوط", "پلدشت"],
        "اردبیل": ["اردبیل", "پارس‌آباد", "مشگین‌شهر", "خلخال", "گرمی", "نمین", "بیله‌سوار", "سرعین", "کوثر", "نیر"],
        "اصفهان": ["اصفهان", "کاشان", "خمینی‌شهر", "نجف‌آباد", "شاهین‌شهر", "شهرضا", "مبارکه", "زرین‌شهر", "گلپایگان", "فریدون‌شهر", "سمیرم", "خوانسار", "نائین", "نطنز", "اردستان"],
        "البرز": ["کرج", "فردیس", "کمال‌شهر", "نظرآباد", "محمدشهر", "ماهدشت", "هشتگرد", "اشتهارد", "طالقان"],
        "ایلام": ["ایلام", "دهلران", "ایوان", "آبدانان", "دره‌شهر", "مهران", "سرابله", "بدره"],
        "بوشهر": ["بوشهر", "برازجان", "بندر گناوه", "خورموج", "کنگان", "عسلویه", "جم", "دیر", "دیلم", "اهرم"],
        "تهران": ["تهران", "شهریار", "اسلامشهر", "بهارستان", "ملارد", "پاکدشت", "ورامین", "قدس", "ری", "قرچک", "پردیس", "بومهن", "دماوند", "رباط‌کریم", "پیشوا", "لواسان"],
        "چهارمحال و بختیاری": ["شهرکرد", "بروجن", "لردگان", "فرخ‌شهر", "فارسان", "هفشجان", "جونقان", "بن", "سامان"],
        "خراسان جنوبی": ["بیرجند", "قائن", "طبس", "فردوس", "نهبندان", "بشرویه", "سرایان", "سربیشه"],
        "خراسان رضوی": ["مشهد", "نیشابور", "سبزوار", "تربت حیدریه", "قوچان", "کاشمر", "چناران", "تربت جام", "تایباد", "گناباد", "فریمان", "سرخس", "درگز", "بردسکن", "خواف"],
        "خراسان شمالی": ["بجنورد", "شیروان", "اسفراین", "آشخانه", "جاجرم", "فاروج", "گرمه", "راز"],
        "خوزستان": ["اهواز", "دزفول", "آبادان", "خرمشهر", "ماهشهر", "اندیمشک", "ایذه", "بهبهان", "شوشتر", "مسجدسلیمان", "بندر امام خمینی", "رامهرمز", "امیدیه", "شوش", "شادگان"],
        "زنجان": ["زنجان", "ابهر", "خرمدره", "قیدار", "هیدج", "صائین‌قلعه", "آب‌بر", "سلطانیه"],
        "سمنان": ["سمنان", "شاهرود", "دامغان", "گرمسار", "مهدی‌شهر", "ایوانکی", "سرخه", "بسطام"],
        "سیستان و بلوچستان": ["زاهدان", "زابل", "ایرانشهر", "چابهار", "سراوان", "خاش", "کنارک", "نیک‌شهر", "پیشین", "زهک"],
        "فارس": ["شیراز", "مرودشت", "جهرم", "فسا", "کازرون", "داراب", "فیروزآباد", "لار", "آباده", "نی‌ریز", "اقلید", "گراش", "استهبان", "کوار"],
        "قزوین": ["قزوین", "الوند", "تاکستان", "آبیک", "محمدیه", "بیدستان", "اقبالیه", "شال"],
        "قم": ["قم", "قنوات", "جعفریه", "کهک", "دستجرد", "سلفچگان"],
        "کردستان": ["سنندج", "سقز", "مریوان", "بانه", "قروه", "کامیاران", "بیجار", "دیواندره", "دهگلان"],
        "کرمان": ["کرمان", "سیرجان", "رفسنجان", "جیرفت", "بم", "زرند", "شهربابک", "کهنوج", "بافت", "راور", "بردسیر"],
        "کرمانشاه": ["کرمانشاه", "اسلام‌آباد غرب", "جوانرود", "کنگاور", "سرپل ذهاب", "سنقر", "هرسین", "صحنه", "پاوه", "روانسر"],
        "کهگیلویه و بویراحمد": ["یاسوج", "دوگنبدان", "دهدشت", "لیکک", "مادوان", "لنده", "سی‌سخت"],
        "گلستان": ["گرگان", "گنبد کاووس", "بندر ترکمن", "علی‌آباد کتول", "آزادشهر", "کردکوی", "کلاله", "آق‌قلا", "مینودشت"],
        "گیلان": ["رشت", "بندر انزلی", "لاهیجان", "لنگرود", "هشتپر", "آستارا", "صومعه‌سرا", "آستانه اشرفیه", "رودسر", "فومن", "ماسال"],
        "لرستان": ["خرم‌آباد", "بروجرد", "دورود", "کوهدشت", "الیگودرز", "الشتر", "نورآباد", "ازنا", "پلدختر"],
        "مازندران": ["ساری", "بابل", "آمل", "قائم‌شهر", "بهشهر", "چالوس", "نوشهر", "بابلسر", "نکا", "محمودآباد", "فریدون‌کنار", "رامسر", "جویبار"],
        "مرکزی": ["اراک", "ساوه", "خمین", "محلات", "دلیجان", "شازند", "تفرش", "آشتیان"],
        "هرمزگان": ["بندرعباس", "میناب", "دهبارز", "قشم", "کیش", "بندر لنگه", "حاجی‌آباد", "کنگ", "پارسیان", "جاسک"],
        "همدان": ["همدان", "ملایر", "نهاوند", "تویسرکان", "اسدآباد", "کبودرآهنگ", "بهار", "رزن"],
        "یزد": ["یزد", "میبد", "اردکان", "بافق", "مهریز", "ابرکوه", "تفت", "اشکذر", "هرات"]
    };

    let weatherState = { temp: 0, desc: '' };

    function login() {
        const u = document.getElementById('fn').value + ' ' + document.getElementById('ln').value;
        if(u.trim().length > 3) {
            localStorage.setItem('user_name', u);
            location.reload();
        }
    }

    function logout() { localStorage.clear(); location.reload(); }

    function loadCities() {
        const p = document.getElementById('p-sel').value;
        const c = document.getElementById('c-sel');
        c.innerHTML = '<option>انتخاب شهر...</option>';
        if(DB[p]) DB[p].forEach(city => c.add(new Option(city, city)));
    }

    async function getWeather() {
        const city = document.getElementById('c-sel').value;
        if(!city || city.includes('انتخاب')) return;
        
        try {
            const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city},IR&appid=${key}&units=metric&lang=fa`);
            const d = await res.json();
            
            document.getElementById('result').style.display = 'block';
            document.getElementById('city-name').innerText = city;
            document.getElementById('temp').innerText = toFa(Math.round(d.main.temp));
            document.getElementById('desc').innerText = d.weather[0].description;
            document.getElementById('icon').innerHTML = `<img src="https://openweathermap.org/img/wn/${d.weather[0].icon}@4x.png">`;
            
            weatherState.temp = d.main.temp;
            weatherState.desc = d.weather[0].description;
            
            generateAIText(city);
        } catch (e) { alert('خطا در دریافت اطلاعات'); }
    }

    function generateAIText(city) {
        const user = localStorage.getItem('user_name').split(' ')[0];
        const texts = [
            `فرهیخته گرامی، جناب ${user}؛ بر اساس محاسبات اتمسفری در ${city}، هم‌اکنون با دمای ${toFa(Math.round(weatherState.temp))} درجه روبرو هستیم. وضعیت آسمان در تجلی "${weatherState.desc}" است.`,
            `جناب ${user}؛ هوای ${city} امروز حکایتی از "${weatherState.desc}" دارد. توصیه می‌شود برنامه‌های خود را با این دمای ${toFa(Math.round(weatherState.temp))} درجه‌ای تنظیم فرمایید.`,
            `همراه گرامی ${user}؛ واکاوی داده‌های ایستگاه ${city} نشان‌دهنده پایداری جوی در وضعیت ${weatherState.desc} است. ایام به کامتان باد.`
        ];
        document.getElementById('ai-text').innerText = texts[Math.floor(Math.random() * texts.length)];
    }

    function askAI() {
        const q = document.getElementById('ai-q').value;
        const box = document.getElementById('ai-reply-box');
        box.style.display = 'block';
        
        if(q.includes('بپوشم') || q.includes('لباس')) {
            box.innerText = weatherState.temp < 15 ? "هوا سرد است، حتماً لباس گرم و ترجیحاً پالتو همراه داشته باشید." : "هوا مطلوب است، لباس نخی یا پیراهن سبک پیشنهاد می‌شود.";
        } else if(q.includes('باران') || q.includes('چتر')) {
            box.innerText = weatherState.desc.includes('باران') ? "بله، احتمال بارش وجود دارد. حتماً چتر بردارید." : "خیر، در حال حاضر شواهدی از بارش باران دیده نمی‌شود.";
        } else if(q.includes('سفر')) {
            box.innerText = "با توجه به وضعیت فعلی، جاده‌ها باز است اما همیشه پیش از حرکت، ایمنی خودرو را چک کنید.";
        } else {
            box.innerText = "من به عنوان هوش مصنوعی هواشناسی، فعلاً فقط در مورد پوشش و شرایط جوی تخصص دارم. سوال دیگری دارید؟";
        }
    }

    window.onload = () => {
        const user = localStorage.getItem('user_name');
        if(user) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('h-ui').style.display = 'flex';
            document.getElementById('main-ui').style.display = 'block';
            document.getElementById('u-display').innerText = user;
            Object.keys(DB).sort().forEach(p => document.getElementById('p-sel').add(new Option(p, p)));
        }
        
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = toFa(now.toLocaleTimeString('fa-IR'));
            document.getElementById('date-fa').innerText = now.toLocaleDateString('fa-IR', {dateStyle:'full'});
            document.body.className = (now.getHours() > 18 || now.getHours() < 6) ? 'night-mode' : 'day-mode';
        }, 1000);
    };
</script>
</body>
</html>
